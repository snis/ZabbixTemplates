zabbix_export:
  version: '7.2'
  template_groups:
    - uuid: 6f1a2b3c0d9e47aa85f2c1d2e3f40596
      name: Templates/HTTP
  templates:
    - uuid: a3f2c1d4e5f647a8b9c0d1e2f3a45678
      template: Uptime Kuma by HTTP
      name: Uptime Kuma by HTTP
      description: |
        The template for receiving Uptime Kuma metrics by HTTP.

        1. In Kuma GUI, select Settings > API Keys > + Add API Key.
        2. Enter a name (ex. zabbix) and choose Expiry date (or Don't expire). Click Generate.
        3. Copy the key, it won't be displayed again!
        4. In Zabbix put the API token into {$KUMA.BASIC_PASS} macro.
        5. Set your Kuma GUI IP/FQDN as {$KUMA.URL} macro value.

        You can discuss this template or leave feedback at https://github.com/snis/ZabbixTemplates

        Generated by @snis
      groups:
        - name: Templates/HTTP
      tags:
        - tag: origin
          value: kuma
      valuemaps:
        - uuid: 9f2a4c1d4e5f47a8b9c0d1e2f3a4567b
          name: Kuma status
          mappings:
            - value: '0'
              newvalue: DOWN
            - value: '1'
              newvalue: UP
            - value: '2'
              newvalue: PENDING
            - value: '3'
              newvalue: MAINTENANCE
        - uuid: 5f7a9c3b2d1e4abca234567890abcdef
          name: Kuma boolean
          mappings:
            - value: '0'
              newvalue: No
            - value: '1'
              newvalue: Yes
      macros:
        - macro: '{$KUMA.URL}'
          value: 'https://kuma.example.com:3001'
          description: 'Base URL to Kuma /metrics. Example: https://kuma.example.com:3001'
        - macro: '{$KUMA.BASIC_USER}'
          value: ''
          description: 'Basic auth username. Leave empty when using API key as password.'
        - macro: '{$KUMA.BASIC_PASS}'
          value: ''
          description: 'If using API key, paste the key here and leave {$KUMA.BASIC_USER} empty. Otherwise use your Basic auth password.'
        - macro: '{$KUMA.CERT.DAYS.WARN}'
          value: '30'
          description: 'Warning if TLS certificate days remaining is below this value.'
        - macro: '{$KUMA.CERT.DAYS.CRIT}'
          value: '7'
          description: 'High severity if TLS certificate days remaining is below this value.'
        - macro: '{$KUMA.RT.WARN}'
          value: '500'
          description: 'Default fallback if no context-specific macro exists (ms). Prefer using {$KUMA.RT.WARN:"<type>"}.'
        - macro: '{$KUMA.RT.CRIT}'
          value: '1500'
          description: 'Default fallback if no context-specific macro exists (ms). Prefer using {$KUMA.RT.CRIT:"<type>"}.'
        - macro: '{$KUMA.MASTER.DELAY}'
          value: '1m'
          description: 'Polling interval for the HTTP master item (kuma.metrics). Increase to reduce load (e.g., 5m or 10m).'
        - macro: '{$KUMA.RT.WARN:"http"}'
          value: '800'
          description: 'Warn threshold for HTTP monitors (ms).'
        - macro: '{$KUMA.RT.CRIT:"http"}'
          value: '1500'
          description: 'Critical threshold for HTTP monitors (ms).'
        - macro: '{$KUMA.RT.WARN:"dns"}'
          value: '100'
          description: 'Warn threshold for DNS monitors (ms).'
        - macro: '{$KUMA.RT.CRIT:"dns"}'
          value: '300'
          description: 'Critical threshold for DNS monitors (ms).'
        - macro: '{$KUMA.RT.WARN:"tcp"}'
          value: '250'
          description: 'Warn threshold for TCP/port monitors (ms).'
        - macro: '{$KUMA.RT.CRIT:"tcp"}'
          value: '600'
          description: 'Critical threshold for TCP/port monitors (ms).'
        - macro: '{$KUMA.RT.WARN:"ping"}'
          value: '100'
          description: 'Warn threshold for PING/ICMP monitors (ms).'
        - macro: '{$KUMA.RT.CRIT:"ping"}'
          value: '300'
          description: 'Critical threshold for PING/ICMP monitors (ms).'
        - macro: '{$KUMA.RT.WARN:"keyword"}'
          value: '800'
          description: 'Warn threshold for HTTP keyword monitors (ms).'
        - macro: '{$KUMA.RT.CRIT:"keyword"}'
          value: '1500'
          description: 'Critical threshold for HTTP keyword monitors (ms).'
        - macro: '{$KUMA.RT.WARN:"port"}'
          value: '250'
          description: 'Warn threshold for TCP port monitors (ms).'
        - macro: '{$KUMA.RT.CRIT:"port"}'
          value: '600'
          description: 'Critical threshold for TCP port monitors (ms).'
      items:
        - uuid: 7b9e3d2a4c5f47e2a1b0c3d4e5f6789a
          name: 'Kuma /metrics'
          type: HTTP_AGENT
          key: kuma.metrics
          delay: '{$KUMA.MASTER.DELAY}'
          value_type: TEXT
          url: '{$KUMA.URL}/metrics'
          timeout: 10s
          authtype: BASIC
          username: '{$KUMA.BASIC_USER}'
          password: '{$KUMA.BASIC_PASS}'
          headers:
            - name: Accept
              value: text/plain
          tags:
            - tag: component
              value: raw
            - tag: origin
              value: kuma
      discovery_rules:
        # -----------------------------
        # LLD #1: All monitors (status + latency)
        # -----------------------------
        - uuid: b1c2d3e4f5a647b88c9d0e1f2a3b4051
          name: 'Discover monitors (status/latency)'
          type: DEPENDENT
          key: kuma.discovery.core
          delay: '0'
          master_item:
            key: kuma.metrics
          preprocessing:
            - type: PROMETHEUS_TO_JSON
              parameters:
                - ''
            - type: JSONPATH
              parameters:
                - "$[?(@.name == 'monitor_status')]"
          lld_macro_paths:
            - lld_macro: '{#NAME}'
              path: "$.labels['monitor_name']"
            - lld_macro: '{#TYPE}'
              path: "$.labels['monitor_type']"
            - lld_macro: '{#URL}'
              path: "$.labels['monitor_url']"
            - lld_macro: '{#HOST}'
              path: "$.labels['monitor_hostname']"
            - lld_macro: '{#PORT}'
              path: "$.labels['monitor_port']"
          item_prototypes:
            - uuid: d3e4f5a6b7c847d89a0b1c2d3e4f4053
              name: "Uptime Kuma status [{#NAME}]"
              type: DEPENDENT
              key: "kuma.monitor.status[{#NAME}]"
              value_type: UNSIGNED
              valuemap:
                name: Kuma status
              master_item:
                key: kuma.metrics
              history: '90d'
              trends: '0d'
              tags:
                - tag: type
                  value: '{#TYPE}'
                - tag: component
                  value: health
                - tag: origin
                  value: kuma
              preprocessing:
                - type: PROMETHEUS_PATTERN
                  parameters:
                    - '{__name__="monitor_status",monitor_name="{#NAME}"}'
                    - value
                - type: DISCARD_UNCHANGED
                  parameters:
                    - ''
            - uuid: e4f5a6b7c8d947e8ab1c2d3e4f5a4054
              name: "Uptime Kuma response time [{#NAME}]"
              type: DEPENDENT
              key: "kuma.monitor.ping[{#NAME}]"
              value_type: FLOAT
              units: ms
              master_item:
                key: kuma.metrics
              tags:
                - tag: type
                  value: '{#TYPE}'
                - tag: component
                  value: latency
                - tag: origin
                  value: kuma
              preprocessing:
                - type: PROMETHEUS_PATTERN
                  parameters:
                    - '{__name__="monitor_response_time",monitor_name="{#NAME}"}'
                    - value
          trigger_prototypes:
            - uuid: c63c584cac4d45d38d60965253fe07ec
              name: "Uptime Kuma: {#NAME} ({#TYPE}) is DOWN"
              expression: 'last(/Uptime Kuma by HTTP/kuma.monitor.status[{#NAME}])=0'
              priority: HIGH
              manual_close: 'YES'
              tags:
                - tag: component
                  value: health
                - tag: type
                  value: '{#TYPE}'
                - tag: scope
                  value: availability
                - tag: origin
                  value: kuma
            - uuid: 35cd870c32aa45cb8c556adfbb286fcd
              name: "Uptime Kuma: High latency on {#NAME} ({#TYPE}) (>={$KUMA.RT.WARN}ms)"
              expression: 'min(/Uptime Kuma by HTTP/kuma.monitor.ping[{#NAME}],5m)>={$KUMA.RT.WARN:"{#TYPE}"}'
              priority: WARNING
              dependencies:
                - name: "Uptime Kuma: {#NAME} ({#TYPE}) is DOWN"
                  expression: 'last(/Uptime Kuma by HTTP/kuma.monitor.status[{#NAME}])=0'
              tags:
                - tag: component
                  value: latency
                - tag: type
                  value: '{#TYPE}'
                - tag: scope
                  value: performance
                - tag: origin
                  value: kuma
            - uuid: 202c7720b1f44ebc99329bd935bef203
              name: "Uptime Kuma: Critical latency on {#NAME} ({#TYPE}) (>={$KUMA.RT.CRIT}ms)"
              expression: 'min(/Uptime Kuma by HTTP/kuma.monitor.ping[{#NAME}],5m)>={$KUMA.RT.CRIT:"{#TYPE}"}'
              priority: HIGH
              dependencies:
                - name: "Uptime Kuma: {#NAME} ({#TYPE}) is DOWN"
                  expression: 'last(/Uptime Kuma by HTTP/kuma.monitor.status[{#NAME}])=0'
              tags:
                - tag: component
                  value: latency
                - tag: type
                  value: '{#TYPE}'
                - tag: scope
                  value: performance
                - tag: origin
                  value: kuma
          graph_prototypes: []
        # -----------------------------
        # LLD #2: TLS-capable monitors only (cert metrics present)
        # -----------------------------
        - uuid: c2d3e4f5a6b747c88d9e0f1a2b3c4052
          name: 'Discover TLS-enabled monitors (cert)'
          type: DEPENDENT
          key: kuma.discovery.cert
          delay: '0'
          master_item:
            key: kuma.metrics
          preprocessing:
            - type: PROMETHEUS_TO_JSON
              parameters:
                - ''
            - type: JSONPATH
              parameters:
                - "$[?(@.name == 'monitor_cert_days_remaining')]"
          lld_macro_paths:
            - lld_macro: '{#NAME}'
              path: "$.labels['monitor_name']"
            - lld_macro: '{#TYPE}'
              path: "$.labels['monitor_type']"
            - lld_macro: '{#URL}'
              path: "$.labels['monitor_url']"
          item_prototypes:
            - uuid: 7767c1863d084c1e99cb26b35bf56e61
              name: "Uptime Kuma cert days remaining [{#NAME}]"
              type: DEPENDENT
              key: "kuma.monitor.cert_days[{#NAME}]"
              value_type: FLOAT
              units: d
              master_item:
                key: kuma.metrics
              history: '0d'
              trends: '0d'
              tags:
                - tag: type
                  value: '{#TYPE}'
                - tag: component
                  value: tls
                - tag: component
                  value: cert
                - tag: component
                  value: health
                - tag: origin
                  value: kuma
              preprocessing:
                - type: PROMETHEUS_PATTERN
                  parameters:
                    - '{__name__="monitor_cert_days_remaining",monitor_name="{#NAME}"}'
                    - value
            - uuid: 3de40e87d76f445cb57fcc5efe2d2a16
              name: "Uptime Kuma cert valid [{#NAME}]"
              type: DEPENDENT
              key: "kuma.monitor.cert_valid[{#NAME}]"
              value_type: UNSIGNED
              valuemap:
                name: Kuma boolean
              master_item:
                key: kuma.metrics
              tags:
                - tag: type
                  value: '{#TYPE}'
                - tag: component
                  value: tls
                - tag: component
                  value: cert
                - tag: component
                  value: health
                - tag: origin
                  value: kuma
              preprocessing:
                - type: PROMETHEUS_PATTERN
                  parameters:
                    - '{__name__="monitor_cert_is_valid",monitor_name="{#NAME}"}'
                    - value
            - uuid: 4d9e5a1f2b2e4c9cb6a0d8e7f3c2b1a0
              name: "Uptime Kuma cert expiry date [{#NAME}]"
              type: DEPENDENT
              key: "kuma.monitor.cert_expire[{#NAME}]"
              value_type: TEXT
              master_item:
                key: kuma.metrics
              history: '0d'
              trends: '0d'
              tags:
                - tag: type
                  value: '{#TYPE}'
                - tag: component
                  value: tls
                - tag: component
                  value: cert
                - tag: component
                  value: health
                - tag: origin
                  value: kuma
              preprocessing:
                - type: PROMETHEUS_PATTERN
                  parameters:
                    - '{__name__="monitor_cert_days_remaining",monitor_name="{#NAME}"}'
                    - value
                - type: JAVASCRIPT
                  parameters:
                    - "var d=new Date(Date.now()+parseFloat(value)*86400*1000);var y=d.getUTCFullYear();var m=('0'+(d.getUTCMonth()+1)).slice(-2);var day=('0'+d.getUTCDate()).slice(-2);return y+'-'+m+'-'+day;"
                - type: DISCARD_UNCHANGED
                  parameters:
                    - ''
          trigger_prototypes:
            - uuid: 6665b6845c6c4423a5c2665c6673435c
              name: "Uptime Kuma: TLS cert expiring soon on {#NAME} ({#TYPE}) (< {$KUMA.CERT.DAYS.WARN}d)"
              expression: 'last(/Uptime Kuma by HTTP/kuma.monitor.cert_days[{#NAME}])<{$KUMA.CERT.DAYS.WARN} and last(/Uptime Kuma by HTTP/kuma.monitor.cert_valid[{#NAME}])=1'
              priority: WARNING
              tags:
                - tag: component
                  value: tls
                - tag: type
                  value: '{#TYPE}'
                - tag: scope
                  value: notice
                - tag: origin
                  value: kuma
            - uuid: 58286bb88777427ba6a08470650d7e81
              name: "Uptime Kuma: TLS cert CRITICAL on {#NAME} ({#TYPE}) (< {$KUMA.CERT.DAYS.CRIT}d)"
              expression: 'last(/Uptime Kuma by HTTP/kuma.monitor.cert_days[{#NAME}])<{$KUMA.CERT.DAYS.CRIT} and last(/Uptime Kuma by HTTP/kuma.monitor.cert_valid[{#NAME}])=1'
              priority: HIGH
              tags:
                - tag: component
                  value: tls
                - tag: type
                  value: '{#TYPE}'
                - tag: scope
                  value: notice
                - tag: origin
                  value: kuma
          graph_prototypes: []

